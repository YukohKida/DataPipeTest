<!DOCTYPE html>
<html>

<head>
    <title>My experiment</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="https://unpkg.com/jspsych@7.3.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <link href="https://unpkg.com/jspsych@7.3.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <!-- css -->
    <style type="text/css">
        details[open]> :not(summary) {
            padding-left: 2em;
            /* 1文字分右へ */
        }
    </style>
</head>

<body></body>
<script>
    // jsPsych のセットアップ
const jsPsych = initJsPsych({
    on_finish: function() {
        jsPsych.data.displayData(); // 実験終了時にデータを表示
    }
});

// クリックイベントを処理する関数
function addClickEvent() {
    document.querySelectorAll('.clickable-text').forEach(element => {
        element.style.pointerEvents = "auto";
        element.addEventListener('click', function(event) {
            event.stopPropagation();
            event.preventDefault();
            const clickedText = this.innerText;

            // データを明示的に記録
            jsPsych.data.write({ clicked_text: clickedText });

            jsPsych.finishTrial(); // クリックで次のトライアルへ
        });
    });
}

// **1つ目の trial (クリックさせる)**
const trial1 = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <details>
            <summary>野菜</summary>
            <p class="clickable-text">トマト</p>
            <p class="clickable-text">にんじん</p>
            <p class="clickable-text">きゅうり</p>
        </details>
    `,
    choices: "NO_KEYS",
    on_load: addClickEvent
};

// **2つ目の trial (クリックした内容を表示)**
const trial2 = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
        // 直前の trial のデータを取得
        const lastData = jsPsych.data.get().last(1).values()[0];
        const clickedText = lastData?.clicked_text || "データなし";
        
        return `<p>あなたがクリックしたのは: <strong>${clickedText}</strong> です。</p>`;
    },
    choices: "NO_KEYS",
    trial_duration: 2000 // 2秒後に自動で次へ
};

// 実験の開始
jsPsych.run([trial1, trial2]);
</script>

</html>
